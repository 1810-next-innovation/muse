null==window.chatplus&&(window.chatplus={}),null==window.chatplusData&&(window.chatplusData={});var __writeIntervalID=null,__readIntervalID=null;null==window.__cp_d&&(window.__cp_d=""),null==window.jp_chatplus_app_accessTime&&(window.jp_chatplus_app_accessTime=""),null==window.jp_chatplus_parts_accessTime&&(window.jp_chatplus_parts_accessTime="");var __c_domain=location.protocol+"//"+location.host;null==window.chatplus.option&&(window.chatplus.option={}),window.chatplus.Audio=function(t){this.src=t,this.src&&(this.audio=new Audio(this.src))},window.chatplus.Audio.prototype={play:function(){!0!==window.chatplus.option.mute&&this.src&&(this.audio.play(),this.audio=new Audio(this.src))}};var AUDIO_LIST={audioTypeMessage:new chatplus.Audio("https://appimg.chatplus.jp/app/s/sound/message.mp3?2"),audioTypeStart:new chatplus.Audio("https://appimg.chatplus.jp/app/s/sound/start.mp3?2"),audioTypeAlert:new chatplus.Audio("https://appimg.chatplus.jp/app/s/sound/alert.mp3?2"),audioTypeClose:new chatplus.Audio("https://appimg.chatplus.jp/app/s/sound/close.mp3?2")};window.chatplus._=window.__.noConflict();var ___startTime=0,___access_time=0,___clFirstMesTime=0,___clLastMesTime=0,___agLastMesTime=0,___cbLastMesTime=0,___ruleIdTime=0,___countClsMess=0,___countAgMess=0,___continuityAgMess=0,___chatmessages=[],___chatbotData=[],___chatbotDataVisitor=[],___chatbotrules={},time_credit_temp=0,pingStartTime=-1,ping_flag=!1,close_by_agent_flag=!1,check_chatbotpart_flag=!1,check_chatbotpart_not_clmes_flag=!1,check_chatbotpart_data_temp=[],chatbotpart_from=0,check_new_message_flag=!1,check_count_mess=!1,config=document.getElementById("chat_config").textContent,customer_tags=[],customer_origins={},chat_tags=[],___match_clMes_checking=!1,___match_clMes_local=!1,___match_clMes_remove=!1,__chatPartId=-1,showLead=!1;window.riot=riot,chatplus.VisitorClient=function(){var self=this,chatData=null,status=null,cpParams={};try{cpParams=JSON.parse(decodeURIComponent(window.location.hash.replace(/^#/,"")))}catch(t){}var chatbotpartId=null,chatplusUsedChatbots=[],ruleaTemp=[],rulebTemp=[],data={key:access_key+"_"+site_id,visitor_id:parseInt(window.__cp_vi)||parseInt(window.va)||null,p:JSON.stringify(jQueryPlus.extend(document.__cp_p,document.__cp_f))};jQueryPlus.ajax({type:"post",url:__cp_d+"/api/chat/parts",data:data,success:function(t){if(1==t.result){for(var a=!1,e=0,s=t.rules.length;e<s;e++)"leavePage"==t.rules[e].timer.on&&(a=!0),ruleaTemp=t.rules[e].rulea,rulebTemp=t.rules[e].ruleb;___access_time=1e3*t.access_time,window.localStorage?window.localStorage.setItem("leavePage",a):__cp_tracker.setCookie("leavePage",a),___chatbotData=t.rules,___chatbotDataVisitor=t.visitor,___chatbotData=self.sort_chatbotpart(___chatbotData),chatplus._.each(___chatbotData,function(t){chatplus._.each(t.action,function(t){"rule"==t.type&&(___chatbotrules[t.value]=0)})}),chatbotpartId=setInterval(self.chatbotpart,1e3,___chatbotData,t.visitor),window.addEventListener("beforeunload",function(){})}}}),riot.observable(self),function(){var pingTimerID=null,regularDelay=2500,slowDelay1=1e4,slowDelay2=25e3,slowDelay3=6e4,delay=regularDelay,pingStartTime=-1,pingChangeTime1=3e5,pingChangeTime2=9e5,pingStopTime=18e5,pingTimeout=1e4,ping_flag=!0,ping_finished=!0,ping_never=!1,data={},received_agent_writing=!1,bot_message_greeting="",client_messages=[],agent_messages=[],bot_messages=[];___startTime=(new Date).getTime(),self.updateVisitor=function(){if("no_chat"==chatplusData.status){if(close_by_agent_flag=!1,"greeting"==status||"in_chat"==status||"in_chatbot"==status)return;status="no_chat",self.trigger("noChat",chatplusData),self.clearsession()}else if("close_chat_by_visitor"==chatplusData.status)status="close_chat_by_visitor",time_credit_temp=0,self.clearsession(),self.trigger("closeChatByVisitor",chatplusData);else if("close_chat_by_agent"==chatplusData.status)status="close_chat_by_agent",close_by_agent_flag||(pingStartTime=(new Date).getTime(),time_credit_temp=0,self.clearsession(),close_by_agent_flag=!0),self.trigger("closeChatByAgent",chatplusData);else if("close_chat_by_mute"==chatplusData.status)status="close_chat_by_mute",self.clearsession(),self.trigger("closeChatByMute",chatplusData);else if("wait_chat"==chatplusData.status){var t=status;status="wait_chat",chatplusData.wait&&(chatplusData.wait.inChatWaiting&&self.addMessages(),chatplusData.config.appearance.calling.disable&&(chatplusData.wait.disable=!0),self.trigger("waitChat",chatplusData.wait,"no_chat"==t))}else if("post_greeting"==chatplusData.status){if("in_chat"==status||"in_chatbot"==status)return;try{window.localStorage?window.localStorage.setItem("windowStatus","open"):__cp_tracker.setCookie("windowStatus","open")}catch(t){}var a={agent:chatplusData.agent,status:"in_chat"==status?"in_chat":"in_chatbot",chat:[{chat_id:0,body:self.parseVariables(chatplusData.posted_greeting),event_from:2,agent_id:chatplusData.agent.id,name:chatplusData.agent.chat_username,event_type:22,bot_rule:chatplusData.posted_greeting_id,created_at:(c=new Date,c.getFullYear()+"/"+(c.getMonth()+1)+"/"+c.getDate()+" "+c.getHours()+":"+c.getMinutes()+":"+c.getSeconds())}]};jQueryPlus.ajax({url:__cp_d+"/api/chat/greeting",method:"POST",data:{key:access_key+"_"+site_id,text:chatplusData.posted_greeting,rule_id:chatplusData.posted_greeting_id,visitor_id:chatplusData.customer.visitor_id}}).done(function(t){t.data.messages&&(t.data.status&&(chatplusData.status="in_chatbot"),chatplusData.messages=t.data.messages,chatplusData.last_message_id=t.data.messages[0].id,self.addMessages()),bot_message_greeting=chatplusData.posted_greeting,___cbLastMesTime=(new Date).getTime()}).fail(function(){}),status="greeting",self.trigger("postGreeting",a)}else if("in_chat"==chatplusData.status||"in_chatbot"==chatplusData.status){if("no_chat"===status||"wait_chat"===status)try{window.localStorage?window.localStorage.setItem("windowStatus","open"):__cp_tracker.setCookie("windowStatus","open")}catch(t){}if(chatplusData.writing){if(jQueryPlus("#writing_box").show(),jQueryPlus("#chatplusview .view")[0]&&!received_agent_writing){received_agent_writing=!0;var e=jQueryPlus("#messages"),s=e[0],i=jQueryPlus("#chatplusview .view")[0];if(void 0===s)return;i.scrollHeight-(s.scrollTop+s.clientHeight)<500&&e.animate({scrollTop:1e6},"fast")}}else received_agent_writing=!1,jQueryPlus("#writing_box").hide();if(self.addMessages(),status===chatplusData.status)return;t=status;status=chatplusData.status,"no_chat"==t&&AUDIO_LIST.audioTypeStart.play(),self.trigger("inChat",chatplusData,"no_chat"==t),pingStartTime=(new Date).getTime(),self.pingReset()}else"no_agent"==chatplusData.status?(status="no_agent",self.trigger("noAgent",chatplusData)):"quit"==chatplusData.status&&(status="close_chat_by_visitor",self.trigger("closeChatByVisitor",chatplusData));var c},self.addMessages=function(){if(chatplusData.messages&&chatplusData.messages.length){pingStartTime=(new Date).getTime(),self.pingReset();var t=chatplus._.filter(chatplusData.messages,function(t){return 23!=t.event_type&&33!=t.event_type}),c=!1,r=!0;chatplus._.each(t,function(t){var a=chatplusData.last_message_id?parseInt(chatplusData.last_message_id,10):-1,e=t.id?parseInt(t.id,10):-1;if(1==t.event_from&&0==___clFirstMesTime&&21==t.event_type&&(___clFirstMesTime=(new Date).getTime()),a<e){var s="";if(1==t.event_from){if(21==t.event_type){___clLastMesTime=(new Date).getTime(),ruleaTemp&&0<ruleaTemp.length&&(check_new_message_flag=!0);var i=t.body;-1!==i.indexOf("<clientmess>")&&(i=i.replace(/<clientmess>/g,"").replace(/<\/clientmess>/g,"")),client_messages.push(i)}}else 21==t.event_type?(___agLastMesTime=(new Date).getTime(),s=t.body,agent_messages.push(t.body),s.indexOf("<input")&&(s=s.substr(0,s.indexOf("<input"))),(s=(s=new RegExp(/<span class="event-trigger">.*<\/span>/).exec(s))?s[0]:null)&&(events=s.substr(s.indexOf("#!!")+3),events=events.substr(0,events.indexOf("<")),events&&self.trigger("sendEvent",{events:events}))):22==t.event_type&&(___cbLastMesTime=(new Date).getTime(),s=t.body,bot_messages.push(t.body.replace(/<ul class='chat-ques'>.*?<\/ul>/g,"")),s.indexOf("<input")&&(s=s.substr(0,s.indexOf("<input"))),(s=(s=new RegExp(/<span class="event-trigger">.*<\/span>/).exec(s))?s[0]:null)&&(events=s.substr(s.indexOf("#!!")+3),events=events.substr(0,events.indexOf("<")),events&&self.trigger("sendEvent",{events:events})));2==t.event_from&&t.body!=s&&(c=!0),self.trigger("receiveMessage",t,!r),2==t.event_from&&(r=!1)}}),c&&AUDIO_LIST.audioTypeMessage.play(),chatplusData.messages.length&&jQueryPlus("#writing_box").hide()}var a;chatplusData.messages&&((a=chatplus._.last(chatplusData.messages))&&(chatplusData.last_message_id=Math.max(chatplusData.last_message_id,a.id)));chatplusData.system&&(self.trigger("updateInfo"),(a=chatplus._.last(chatplusData.system))&&(chatplusData.last_message_id=Math.max(chatplusData.last_message_id,a.id)))},self._ping=function(){pingStartTime<0&&(pingStartTime=___startTime);var t=(new Date).getTime()-pingStartTime;if(chatplus._.contains(["in_chat","in_chatbot","wait_chat"],status))delay=pingStopTime<t?slowDelay3:pingChangeTime2<t?slowDelay2:pingChangeTime1<t?slowDelay1:regularDelay;else{if(pingStopTime<t)return void(ping_flag=!1);delay=pingChangeTime2<t?slowDelay2:slowDelay1}if(ping_finished){ping_finished=!1;var a={key:access_key+"_"+site_id,last_message_id:chatplusData.last_message_id,visitor_id:chatplusData.customer.visitor_id,chat_id:chatplusData.origin_chat_id,status:chatplusData.status};chatplusData.wait&&chatplusData.wait.inChatWaiting&&(a.inChatWaiting=chatplusData.inChatWaiting),jQueryPlus.ajax({type:"post",url:__cp_d+"/api/chat/ping",data:a,timeout:pingTimeout,error:function(t,a,e){window.console.error("ping",a),ping_finished=!0},success:function(t){if(ping_finished=!0,1==t.result){if(t.data.chat_id==chatplusData.origin_chat_id&&(chatplusData.status=t.data.status),t.data.display_when_restart&&(chatplus.display_when_restart=t.data.display_when_restart,chatplusData.display_when_restart=t.data.display_when_restart),t.data.agent&&(chatplusData.agent=t.data.agent),chatplusData.writing=t.data.writing,chatplusData.messages=t.data.messages,chatplusData.system=t.data.system,chatplusData.wait=t.data.wait,"wait_chat"==chatplusData.status&&t.data.select&&(chatplusData.wait.select=!0),t.data.inChatWaiting&&(chatplusData.wait.inChatWaiting=!0),chatplusData.chat_id=t.data.chat_id,chatplus._.isArray(t.data.messages))for(var a=chatplus._.last(___chatmessages),e=0;e<t.data.messages.length;e++)a&&a.id<t.data.messages[e].id&&___chatmessages.push(t.data.messages[e]),null==a&&___chatmessages.push(t.data.messages[e]);0<___chatmessages.length&&(___countAgMess=___countClsMess=0,chatplus._.each(___chatmessages,function(t){1==t.event_from?(21==t.event_type&&___countClsMess++,___continuityAgMess=0):21==t.event_type?(___countAgMess++,___continuityAgMess=0):22<=t.event_type&&t.event_type<=29&&___continuityAgMess++}),100<=___continuityAgMess&&self.clearsession(),check_count_mess=!0),self.updateVisitor()}}})}pingTimerID=setTimeout(self._ping,delay)},self.clearsession=function(){client_messages=[],agent_messages=[],bot_messages=[],___countAgMess=___countClsMess=___ruleIdTime=___cbLastMesTime=___agLastMesTime=___clLastMesTime=___clFirstMesTime=0,check_new_message_flag=check_chatbotpart_flag=!(___chatmessages=[]),chatplusUsedChatbotsRules=[]},self.check_chatbotpart=function(a,t,e){var s=!1,i=!1,c=0,r=t.status;if(0<a.length)for(var n=0,_=a.length;n<_;n++){var l=null;if("clMes"===a[n][2]&&e)l=!1,rule_mess_check=!1,i=l=chatplus._.some(client_messages,function(t){switch(a[n][3]){case"\u4e00\u81f4\u3059\u308b":case"=":return t==a[n][4];case"\u4e00\u81f4\u3057\u306a\u3044":case"!=":return t!=a[n][4];case"\u542b\u3080":case"in":return t&&-1!==t.indexOf(a[n][4]);case"\u542b\u307e\u306a\u3044":case"out":return t&&-1===t.indexOf(a[n][4])}});else if("agMes"===a[n][2])l=!1,l=chatplus._.some(agent_messages,function(t){switch(a[n][3]){case"=":return t==a[n][4];case"!=":return t!=a[n][4];case"in":return t&&-1!==t.indexOf(a[n][4]);case"out":return t&&-1===t.indexOf(a[n][4])}});else if("botMes"===a[n][2])l=!1,l=chatplus._.some(bot_messages,function(t){switch(a[n][3]){case"=":return t==a[n][4];case"!=":return t!=a[n][4];case"in":return t&&-1!==t.indexOf(a[n][4]);case"out":return t&&-1===t.indexOf(a[n][4])}});else if("agStart"===a[n][2])switch(l=!1,agStart=___countAgMess,a[n][3]){case"true":if(1<=agStart){l=!0;break}break;case"false":if(agStart<1){l=!0;break}}else if("clStart"===a[n][2])switch(l=!1,clStart=___countClsMess,a[n][3]){case"true":if(1<=clStart){l=!0;break}break;case"false":if(clStart<1){l=!0;break}}else if("clTag"===a[n][2]){if(customer_tags){l=!1;for(var o=[],u=0,p=customer_tags.length;u<p;u++){var d=customer_tags[u];switch(a[n][3]){case"\u4e00\u81f4\u3059\u308b":case"=":d==a[n][4]&&(l=!0);break;case"\u4e00\u81f4\u3057\u306a\u3044":case"!=":d!=a[n][4]?o.push(!0):o.push(!1);break;case"\u542b\u3080":case"in":if(-1===d.indexOf(a[n][4]))break;l=!0;break;case"\u542b\u307e\u306a\u3044":case"out":-1===d.indexOf(a[n][4])?o.push(!0):o.push(!1)}}if(!l&&o.length){for(var g=!1,h=0,f=o.length;h<f;h++);if(!o[h]){g=!0;break}g||(l=!0)}}}else if("checkTime"===a[n][2]){var m=JSON.parse("["+a[n][4]+"]"),D=4*(w=new Date).getHours()+Math.floor(w.getMinutes()/15);l=m[0]<=D&&D<=m[1]}else if("checkWeek"===a[n][2]){m=JSON.parse("["+a[n][4]+"]");var v=(w=new Date).getDay();l=chatplus._.contains(m,v)}else if("checkDate"===a[n][2]){m=a[n][4].split(",").map(Date.parse);var w,y=(w=new Date).getTime();l=m[0]<=y&&y<=m[1]}else if("rmStatus"===a[n][2])switch(l=!1,a[n][4]){case"\u8a2a\u554f\u4e2d":if("no_chat"!=r)break;l=!0;break;case"\u30c1\u30e3\u30c3\u30c8\u4e2d":if("in_chat"!=r)break;l=!0;break;case"\u30c1\u30e3\u30c3\u30c8\u30dc\u30c3\u30c8":if("in_chatbot"!=r)break;l=!0;break;case"\u4f11\u6b62\u4e2d":if("suspend_chat"!=r)break;l=!0;break;case"\u7d42\u4e86":if("close_chat_by_visitor"!=r)break;l=!0}else if("agTagStatus"===a[n][2])l=null;else if("code"===a[n][2])l=null;else if("wait"===a[n][2])l=!1,"wait_chat"==r&&(l=!0);else if("chatTag"===a[n][2]&&chat_tags){l=!1;var b=a[n][4].split(/\s+/);switch(a[n][3]){case"=":l=chatplus._.contains(chat_tags,a[n][4]);break;case"!=":l=!chatplus._.contains(chat_tags,a[n][4]);break;case"in":l=chatplus._.some(chat_tags,function(t){return-1!==t.indexOf(a[n][4])});break;case"out":l=chatplus._.every(chat_tags,function(t){return-1===t.indexOf(a[n][4])});break;case"some":l=chatplus._.some(b,function(t){return chatplus._.contains(chat_tags,t)});break;case"every":l=chatplus._.every(b,function(t){return chatplus._.contains(chat_tags,t)});break;case"any":l=chatplus._.some(b,function(t){return!chatplus._.contains(chat_tags,t)});break;case"none":l=chatplus._.every(b,function(t){return!chatplus._.contains(chat_tags,t)})}}if(null!==l){if(e&&"or"==a[n][1]&&!l)continue;if(!e&&"or"==a[n][1]&&0<c&&!l)continue;if(e||"or"!=a[n][1]||0!=c||l){if("and"==a[n][1]&&0<c&&!s)continue}else l=!0;s=l,c++}}e?(___match_clMes_local=s&&i,check_chatbotpart_flag=s):(check_chatbotpart_not_clmes_flag=s,chatbotpart_from+=c)},self.chatbotpart=function(chatbotData,userData,on_leavepage){for(var i=0,l=chatbotData.length;i<l;i++){for(var config=chatbotData[i],action_a_flag=!0,action_b_flag=!0,action_timer_flag=!1,usedChatBot=!0,rule_mess_check=!1,timer=config.timer,rulea=config.rulea||[],ruleb=config.ruleb||[],action=config.action,ruleaRule="",a=0,al=rulea.length;a<al;a++)ruleaRule=rulea[a][2],!userData||"wait"!==rulea[a][2]&&"clMes"!==rulea[a][2]&&"agMes"!==rulea[a][2]&&"botMes"!==rulea[a][2]&&"clTag"!==rulea[a][2]?"clUnexpMes"==rulea[a][2]&&(check_chatbotpart_flag=___match_clMes_checking&&!___match_clMes_local?(rule_mess_check=!0,action_a_flag=!0,!0):(action_a_flag=!1,!1)):(""!=bot_message_greeting&&(bot_messages.push(bot_message_greeting),bot_message_greeting=""),self.check_chatbotpart(rulea,chatplusData,!0),action_a_flag=check_chatbotpart_flag,action_a_flag&&"clMes"===rulea[a][2]&&(rule_mess_check=!0,___match_clMes_local=!0,___match_clMes_checking=!1));for(var b=0,bl=ruleb.length;b<bl;b++)!userData||"rmStatus"!==ruleb[b][2]&&"clStart"!==ruleb[b][2]&&"agStart"!==ruleb[b][2]||(self.check_chatbotpart(ruleb,chatplusData,!0),action_b_flag=check_chatbotpart_flag);if(on_leavepage)action_timer_flag=timer&&"leavePage"==timer.on;else if(timer){var now=(new Date).getTime(),elapsed=now-___startTime;"openPage"==timer.on&&1e3*timer.sec<elapsed&&(action_timer_flag=!0),"openSite"==timer.on&&1e3*timer.sec<___access_time+elapsed&&(action_timer_flag=!0),"clFirstMes"==timer.on&&0!==___clFirstMesTime&&1e3*timer.sec<now-___clFirstMesTime&&(action_timer_flag=!0),"clLastMes"==timer.on&&0!==___clLastMesTime&&1e3*timer.sec<now-___clLastMesTime&&(action_timer_flag=!0),"agLastMes"==timer.on&&0!==___agLastMesTime&&1e3*timer.sec<now-___agLastMesTime&&(action_timer_flag=!0),"cbLastMes"==timer.on&&0!==___cbLastMesTime&&1e3*timer.sec<now-___cbLastMesTime&&(action_timer_flag=!0),"rule"==timer.on&&0!==___ruleIdTime&&1e3*timer.sec<now-___ruleIdTime&&(action_timer_flag=!0),"none"==timer.on&&(action_timer_flag=!0),"leavePage"==timer.on&&(action_timer_flag=!1)}else action_timer_flag=!0;if(-1==jQueryPlus.inArray(config.id,chatplusUsedChatbots)&&(usedChatBot=!1),action_timer_flag&&action_a_flag&&action_b_flag&&!usedChatBot){"agMes"!==ruleaRule&&"botMes"!==ruleaRule||(rule_mess_check=!0),rule_mess_check||chatplusUsedChatbots.push(config.id);var current_message=client_messages.pop();check_new_message_flag=!1;for(var chatmessages=[],ruleIds=[],actionIndex=0,pad_left=function(t,a,e){if("padStart"in String.prototype)return t.toString().padStart(e,a);for(var s="",i=0;i<e;i++)s+=a;return(s+=t.toString()).substr(-1*e)},p=0,pl=action.length;p<pl;p++){actionIndex++;var botID=config.id,ruleReferer="";if(botID&&-1!=String(botID).indexOf("_")){var botInfo=String(botID).split("_");botID=botInfo[0],botInfo[2]&&(ruleReferer="2_"+pad_left(botInfo[2],"0",6)+"_1")}var ruleId="2_"+pad_left(botID,"0",6)+"_"+pad_left(actionIndex,"0",2);if(-1==chatplus._.indexOf(["text","text_select","stamp","imagemap","textform","confirm","randomchat","file"],action[p].type)){if(jQueryPlus.ajax({url:__cp_d+"/api/chat/eventlog",method:"POST",data:{key:access_key+"_"+site_id,rule_id:ruleId,bot_referer:ruleReferer,num:null,visitor_id:chatplusData.customer.visitor_id}}).done(function(t){}).fail(function(){}),"url"==action[p].type)void 0===action[p].same_tab?self.trigger("jumpPage",{URL:action[p].value,same_tab:!1}):self.trigger("jumpPage",{URL:action[p].value,same_tab:action[p].same_tab});else if("code"==action[p].type){var code=action[p].value;try{code=self.parseVariables(code),eval(code)}catch(t){console.log("chatplus script error",t)}}else if("rule"==action[p].type)ruleIds.push(action[p].value);else if("attrvisitor"==action[p].type)try{var values=action[p].value.split("_"),attr={};attr[values[0]]=values[1];var visitor_id=chatplusData.customer.visitor_id;ChatplusAction.addVisitorAttribute(access_key,site_id,visitor_id,attr,function(t){})}catch(t){console.error(t)}else if("tagvisitor"==action[p].type)try{var visitor_id=chatplusData.customer.visitor_id,tags=action[p].value.split(/[,\s]+/);ChatplusAction.addVisitorTag(access_key,site_id,visitor_id,tags,function(t){})}catch(t){console.error(t)}else if("tagagent"==action[p].type)try{var tags=action[p].value.split(/[,\s]+/);ChatplusAction.addAgentTag(access_key,site_id,chatplusData.agent.id,tags,function(t){})}catch(t){console.error(t)}else if("tagchat"==action[p].type)try{var tags=action[p].value.split(/[,\s]+/);ChatplusAction.addChatTag(access_key,site_id,chatplusData.chat_id,tags,function(t){})}catch(t){console.error(t)}else if("status"==action[p].type)self.trigger("changeStatus",{status:action[p].value});else if("assign"==action[p].type){var value=action[p].value.split("_");self.trigger("changeAgent",{mode:value[0],target:value[1],status:"*"})}else if("trigger"==action[p].type){var events=self.parseVariables(action[p].value);0===events.indexOf("#!!")&&self.trigger("sendEvent",{events:events.substr(3)})}}else time_credit_temp=0<=time_credit_temp?time_credit_temp:0,"agMes"===ruleaRule&&(ruleReferer="agent"),"similar"==action[p].type&&(action[p].greeting=current_message),chatmessages.push(action[p])}if(chatmessages.length){if("in_chat"!=status&&"in_chatbot"!=status){if(!chatplusData.agent)return;if("wait_chat"==chatplusData.status)return;try{window.localStorage?window.localStorage.setItem("windowStatus","open"):__cp_tracker.setCookie("windowStatus","open")}catch(t){}}jQueryPlus.ajax({url:__cp_d+"/api/chat/greetingparts",method:"POST",data:{key:access_key+"_"+site_id,text:JSON.stringify(chatmessages),visitor_id:userData,agent_id:chatplusData.agent?chatplusData.agent.id:null,timer:timer.sec,rule_id:ruleId,bot_referer:ruleReferer,time_credit:time_credit_temp}}).done(function(t){rule_mess_check&&(client_messages=[]),t.data&&(time_credit_temp=t.data.time_credit)}).fail(function(){})}if(ruleIds.length&&jQueryPlus.ajax({url:__cp_d+"/api/chat/ruleparts",method:"POST",data:{key:access_key+"_"+site_id,ids:ruleIds,visitor_id:userData,chat_id:chatplusData.chat_id,timer:timer.sec,time_credit:time_credit_temp}}).done(function(a){a.result&&chatplus._.isArray(a.data.rules)&&chatplus._.each(chatbotData,function(t){chatplus._.each(a.data.rules,function(t){var a="";if(ruleId){var e=ruleId.split("_");e[1]&&(a=e[1])}"ruleId"==t.timer.on&&(t.timer.on="rule",t.id=t.id+"_"+(new Date).getTime(),a&&(t.id=t.id+"_"+a),chatbotData.push(t))}),___ruleIdTime=(new Date).getTime(),clearInterval(chatbotpartId),chatbotData=self.sort_chatbotpart(chatbotData),chatbotpartId=setInterval(self.chatbotpart,1e3,chatbotData,a.data.visitor)})}).fail(function(){}),jQueryPlus.ajax({url:__cp_d+"/api/chat/use_chatbotpart",method:"POST",data:{key:access_key+"_"+site_id,part_id:config.id,visitor_id:userData}}).done(function(t){}).fail(function(){}),chatplusUsedChatbots.length==chatbotData.length){clearInterval(chatbotpartId);break}}}___match_clMes_checking=!1,___match_clMes_local=!1,client_messages=[],agent_messages=[],bot_messages=[]},self.chatbotpart_ClMes=function(t,a){for(var e=0,s=t.length;e<s;e++){var i=t[e];__chatPartId=i.id;var c=!0,r=!0,n=!1,_=i.timer,l=i.rulea?i.rulea:[],o=i.ruleb?i.ruleb:[];i.action;if(_?"none"==_.on&&(n=!0):n=!0,n){if(chatbotpart_from=0,a&&0<l.length)for(var u=0,p=l.length;u<p;u++)"wait"!==l[u][2]&&"agMes"!==l[u][2]&&"botMes"!==l[u][2]&&"clTag"!==l[u][2]||(self.check_chatbotpart(l,chatplusData,!1),c=check_chatbotpart_not_clmes_flag);if(a&&0<o.length)for(var d=0,g=o.length;d<g;d++)"rmStatus"!==o[d][2]&&"clStart"!==o[d][2]&&"agStart"!==o[d][2]||(self.check_chatbotpart(o,chatplusData,!1),r=check_chatbotpart_not_clmes_flag);var h={};h[__chatPartId]=0,h.i=chatbotpart_from,c&&r&&(h[__chatPartId]=1),-1==JSON.stringify(check_chatbotpart_data_temp).indexOf(JSON.stringify(h))&&check_chatbotpart_data_temp.push(h)}}},self.sort_chatbotpart=function(t){for(var a=[],e=[],s=0,i=t.length;s<i;s++){var c=t[s],r=c.rulea,n=!1;if(r)for(var _=0,l=r.length;_<l;_++)if("clUnexpMes"==r[_][2]){n=!0;break}n?a.push(c):e.push(c)}return e.concat(a)},self.pingReset=function(){ping_never||(delay!==regularDelay&&(delay=regularDelay,clearTimeout(pingTimerID),self._ping()),ping_flag||(ping_flag=!0,self._ping()))},self.parseVariables=function(s){if(!s||!s.match(/___[^_]+___/))return s;if(s=(s=s.replace(/___date___/g,new Date)).replace(/___url___/g,location.href),chatplusData.status&&(s=s.replace(/___status___/g,chatplusData.status)),chatplusData.customer){var t=s.match(/___cl\.[^_]+___/g);t&&(t=chatplus._.uniq(t),chatplus._.each(t,function(t){var a=t.substr(6,t.length-9);if("tags"===(a=a.replace(/[A-Z]/g,function(t){return"_"+t.charAt(0).toLowerCase()}))){var e=customer_tags?customer_tags.join(","):"";s=s.replace(new RegExp(t,"g"),e)}else 0===a.indexOf("*")?(a=a.substr(1),customer_origins.hasOwnProperty(a)&&(s=s.replace(new RegExp(t,"g"),customer_origins[a]))):chatplusData.customer.hasOwnProperty(a)&&(s=s.replace(new RegExp(t,"g"),chatplusData.customer[a]))}))}if(chatplusData.agent){var a=s.match(/___ag\.[^_]+___/g);a&&(a=chatplus._.uniq(a),chatplus._.each(a,function(t){var a=t.substr(6,t.length-9);a=a.replace(/[A-Z]/g,function(t){return"_"+t.charAt(0).toLowerCase()});chatplusData.agent.hasOwnProperty(a)&&(s=s.replace(new RegExp(t,"g"),chatplusData.agent[a]))}))}return s};var ppf=document.__cp_f,ppp=document.__cp_p,pp=JSON.stringify(jQueryPlus.extend(ppp,ppf));jQueryPlus.ajax({url:__cp_d+"/api/chat/initialize",method:"POST",data:{key:access_key+"_"+site_id,visitor_id:va,p:pp,referrer:window.location.href}}).done(function(t){if(1==t.result){if(chatplusData=t.data,chatplusData.origin_chat_id=chatplusData.chat_id,chatplusData.customer.custom_fields){var a,e=JSON.parse(chatplusData.customer.custom_fields),s=e[0];a=s&&s.hasOwnProperty("_tags")?(customer_tags=s._tags,e.slice(1,e.length)):e.slice(0,e.length),customer_origins=a.reduce(function(t,a){return chatplus._.extend(t,a)},{})}if(ChatplusAction.getChatInfo(access_key,site_id,chatplusData.chat_id,function(t){chat_tags=t.data.chat.tags}),t.data.wait&&t.data.inChatWaiting&&(chatplusData.wait.inChatWaiting=!0),(chatplusData.config=config).appearance&&config.appearance.sounds){var i={start:config.appearance.sounds.start?"https://appimg.chatplus.jp/app/s/sound/"+config.appearance.sounds.start:null,receive:config.appearance.sounds.receive?"https://appimg.chatplus.jp/app/s/sound/"+config.appearance.sounds.receive:null};AUDIO_LIST.audioTypeStart=new chatplus.Audio(i.start),AUDIO_LIST.audioTypeMessage=new chatplus.Audio(i.receive)}if(t.data.congestion)return ping_never=!(ping_flag=!1),time_credit_temp=0,self.clearsession(),void self.updateVisitor();try{var c=parseInt(__cp_tracker.getCookie("chat-suppressed-until"));window.localStorage&&(c=c||parseInt(localStorage.getItem("chat-suppressed-until"))),c&&(c>=Date.now()?jQueryPlus("#chatplusview").hide():(__cp_tracker.removeCookie("chat-suppressed-until"),window.localStorage&&localStorage.removeItem("chat-suppressed-until")))}catch(t){}chatplusData.past_chat_id=t.data.past_chat_id?t.data.past_chat_id:0,chatplusData.past_message_first=t.data.past_message_first?t.data.past_message_first:0,chatplusData.past_message_id=0;var r=chatplus._.filter(t.data.messages,function(t){return 23!=t.event_type&&33!=t.event_type});if(___chatmessages=r,chatplusData.messages=[],(t.data.no_prompt||t.data.no_bot_prompt)&&self.trigger("updatePrompt",t.data),chatplusData.system=t.data.system,self.updateVisitor(),chatplusData.last_message_id=0,r&&r.length&&"no_chat"!=t.data.status){var n=chatplus._.last(r);n&&(chatplusData.last_message_id=Math.max(chatplusData.last_message_id,n.id)),(t.data.system?chatplus._.last(t.data.system):null)&&(chatplusData.last_message_id=Math.max(chatplusData.last_message_id,n.id)),self.trigger("listMessages",{data:r})}if(t.data.past_messages&&(chatplusData.past_messages_offset=t.data.past_messages_offset||0,self.trigger("showPastMessages",{messages:t.data.past_messages})),chatplusData.greeting)var _=window.setInterval(function(t){var a=parseInt(((new Date).getTime()-t.accessTime)/1e3);if(chatplusData.greeting||clearInterval(_),chatplusData.greeting&&a>=chatplusData.greeting.time){if(clearInterval(_),!chatplusData.agent||"wait_chat"==chatplusData.status||r&&0<r.length)return;chatplusData.status="post_greeting",chatplusData.posted_greeting=chatplusData.greeting.greeting,chatplusData.posted_greeting_id=chatplusData.greeting.id,self.updateVisitor()}},500,{accessTime:jp_chatplus_app_accessTime,greeting:chatplusData.greeting});chatplusData.expiration?ping_never=!(ping_flag=!1):self._ping();t={type:"get-visitor-option",access_key:access_key};var l=document.getElementById("jp.chatplus.app_chat_frame");if(l)l.contentWindow.postMessage(t,"*");else{void 0===window.chatplus.option&&(window.chatplus.option={});var o="chatplus_visitor_option_"+access_key;if(new RegExp("(?:^|;\\s*)"+escape(o).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(window.document.cookie)){var u=unescape(window.document.cookie.replace(new RegExp("(?:^|.*;\\s*)"+escape(o).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*"),"$1"));window.chatplus.option=JSON.parse(u)}}self.trigger("initialized",{}),self.trigger("Startforce",{})}}).fail(function(){}),self.on("reinit",function(e){pingStartTime=(new Date).getTime(),time_credit_temp=0,self.clearsession(),self.reinit=!0,e.reDisplay?(clearTimeout(pingTimerID),ping_flag=!1,jQueryPlus.ajax({url:__cp_d+"/api/chat/reinit",method:"POST",data:{key:access_key+"_"+site_id,visitor_id:chatplusData.customer.visitor_id}}).done(function(t){if(1==t.result){if(t.data.ga_events&&(chatplusData.config.ga.events=t.data.ga_events),chatplusData.origin_chat_id=t.data.chat_id,chatplusData.status=t.data.status,t.data.congestion)return ping_never=!(ping_flag=!1),clearTimeout(pingTimerID),time_credit_temp=0,void self.clearsession();if("wait_chat"==chatplusData.status)return chatplusData.agent=t.data.agent,chatplusData.wait=t.data.wait,chatplusData.wait.force=!0,self.trigger("initMessage",{}),void self.updateVisitor();(t.data.no_prompt||t.data.no_bot_prompt)&&self.trigger("updatePrompt",t.data),status="no_chat";var a=(new Date).getTime();pingStartTime=___startTime=a,chatplusData.past_chat_id=0,chatplusData.past_message_id=0,chatplusData.past_message_first=0,"no_agent"==chatplusData.status?(self.pingReset(),self.updateVisitor()):jQueryPlus.ajax({url:__cp_d+"/api/chat/request",method:"POST",data:{key:access_key+"_"+site_id,form:e,visitor_id:chatplusData.customer.visitor_id,reinit:self.reinit}}).done(function(t){if(1==t.result){if(chatplusData.status=t.data.status,chatplusData.wait=t.data.wait,"wait_chat"==chatplusData.status&&chatplusData.wait)chatplusData.wait.force=!0,t.data.select&&(chatplusData.wait.select=!0);else if(chatplusData.wait&&chatplusData.congestion)return ping_never=!(ping_flag=!1),clearTimeout(pingTimerID),time_credit_temp=0,self.clearsession(),void self.updateVisitor();chatplusData.customer.chat_username=t.data.customer.chat_username,chatplusData.customer.chat_company=t.data.customer.chat_company,chatplusData.customer.chat_email=t.data.customer.chat_email,chatplusData.customer.chat_tel=t.data.customer.chat_tel,chatplusData.past_chat_id=t.data.past_chat_id?t.data.past_chat_id:0,chatplusData.past_message_first=t.data.past_message_first?t.data.past_message_first:0,t.data.past_messages&&(chatplusData.past_messages_offset=t.data.past_messages_offset||0,self.trigger("showPastMessages",{messages:t.data.past_messages})),self.updateVisitor(),ping_never=!1,self.trigger("quickStart")}self.pingReset()}).fail(function(){self.pingReset()})}}).fail(function(){self.pingReset()})):jQueryPlus.ajax({url:__cp_d+"/api/chat/reinit",method:"POST",data:{key:access_key+"_"+site_id,visitor_id:chatplusData.customer.visitor_id}}).done(function(t){if(1==t.result){if(t.data.ga_events&&(chatplusData.config.ga.events=t.data.ga_events),chatplusData.origin_chat_id=t.data.chat_id,chatplusData.status=t.data.status,t.data.congestion)return ping_never=!(ping_flag=!1),clearTimeout(pingTimerID),time_credit_temp=0,self.clearsession(),self.trigger("initMessage",{}),void self.updateVisitor();"wait_chat"==chatplusData.status&&(chatplusData.agent=t.data.agent,chatplusData.wait=t.data.wait,chatplusData.wait.force=!0),status="no_chat",(t.data.no_prompt||t.data.no_bot_prompt)&&self.trigger("updatePrompt",t.data),self.trigger("initMessage",{}),self.updateVisitor();var a=(new Date).getTime();pingStartTime=___startTime=a,ping_never=!1,self.pingReset()}}).fail(function(){})}),self.on("openPreSurvey",function(t){chatplusData.greeting&&(chatplusData.greeting=null)}),self.on("requestChat",function(t){self.requesting||(self.requesting=!0,pingStartTime=(new Date).getTime(),time_credit_temp=0,chatplusData.past_chat_id=0,chatplusData.past_message_id=0,chatplusData.past_message_first=0,self.clearsession(),t.reinit&&(self.reinit=!0),jQueryPlus.ajax({url:__cp_d+"/api/chat/request",method:"POST",data:{key:access_key+"_"+site_id,form:t,visitor_id:chatplusData.customer.visitor_id,reinit:self.reinit}}).done(function(t){delete self.requesting,1==t.result&&(chatplusData.status=t.data.status,chatplusData.customer.chat_username=t.data.customer.chat_username,chatplusData.customer.chat_company=t.data.customer.chat_company,chatplusData.customer.chat_email=t.data.customer.chat_email,chatplusData.customer.chat_tel=t.data.customer.chat_tel,chatplusData.wait=t.data.wait,t.data.congestion?(chatplusData.wait.congestion=!0,clearTimeout(pingTimerID),ping_never=!0):t.data.select&&(chatplusData.wait.select=!0),chatplusData.past_chat_id=t.data.past_chat_id?t.data.past_chat_id:0,chatplusData.past_message_first=t.data.past_message_first?t.data.past_message_first:0,t.data.past_messages&&(chatplusData.past_messages_offset=t.data.past_messages_offset||0,self.trigger("showPastMessages",{messages:t.data.past_messages})),self.updateVisitor(),self.trigger("quickStart")),self.pingReset()}).fail(function(){}))}),self.on("writing",function(t){"in_chat"==chatplusData.status&&jQueryPlus.ajax({url:__cp_d+"/api/chat/writing",method:"POST",data:{key:access_key+"_"+site_id,text:t.text,visitor_id:chatplusData.customer.visitor_id,last_message_id:chatplusData.last_message_id}}).done(function(){}).fail(function(){})}),self.on("quitChat",function(a){pingStartTime=(new Date).getTime(),time_credit_temp=0,self.clearsession(),jQueryPlus.ajax({url:__cp_d+"/api/chat/quit",method:"POST",data:{key:access_key+"_"+site_id,visitor_id:chatplusData.customer.visitor_id},async:!("unload"==a.on)}).done(function(t){"unload"!=a.on&&1==t.result&&(chatplus.status=t.data.status,chatplusData.status=t.data.status,chatplus.display_when_restart=t.data.display_when_restart,chatplusData.display_when_restart=t.data.display_when_restart,self.updateVisitor(),self.pingReset())}).fail(function(){});try{window.localStorage?window.localStorage.removeItem("ga_used"):__cp_tracker.removeCookie("ga_used")}catch(t){console.log(t)}}),self.on("changeStatus",function(a){jQueryPlus.ajax({url:__cp_d+"/api/chat/change_status",method:"POST",data:{key:access_key+"_"+site_id,status:a.status,text:a.text,visitor_id:chatplusData.customer.visitor_id,last_message_id:chatplusData.last_message_id,bot_referer:a.rule_id?a.rule_id:null,num:a.num?a.num:null}}).done(function(t){chatplusData.status=a.status,___match_clMes_checking=a.text&&!t.data.match_clMes,"no_chat"==a.status?(self.trigger("initMessage",{}),self.clearsession(),chatplusUsedChatbots=[]):"no_agent"==a.status?(chatplusData.change_status=!0,ping_never=!(ping_flag=!1),clearTimeout(pingTimerID),time_credit_temp=0,self.clearsession(),self.updateVisitor(),jQueryPlus.ajax({url:__cp_d+"/api/chat/quit",method:"POST",data:{key:access_key+"_"+site_id,visitor_id:chatplusData.customer.visitor_id}}).done(function(t){}).fail(function(){})):(chatplusData.status=t.data.status,chatplusData.messages=t.data.messages,"wait_chat"==chatplusData.status&&(chatplusData.wait=t.data.wait,chatplusData.wait.force=!0,t.data.select&&(chatplusData.wait.select=!0),t.data.inChatWaiting&&(chatplusData.wait.inChatWaiting=!0)),t.data.display_when_restart&&(chatplusData.display_when_restart=t.data.display_when_restart),self.updateVisitor())}).fail(function(){}),___startTime=(new Date).getTime(),self.pingReset()}),self.on("changeAgent",function(a){var t={key:access_key+"_"+site_id,visitor_id:chatplusData.customer.visitor_id,mode:a.mode,target:a.target,status:a.status?a.status:null,last_message_id:chatplusData.last_message_id,rule_id:a.rule_id?a.rule_id:null,num:a.num?a.num:null};if(a.text){self.chatbotpart_ClMes(___chatbotData,___chatbotDataVisitor),pingStartTime=(new Date).getTime();var e=document.__cp_p;e&&"object"==typeof e&&(e=JSON.stringify(e)),t.text=a.text,t.start=!0,t.check_chatbotpart=JSON.stringify(check_chatbotpart_data_temp),t.p=e}jQueryPlus.ajax({url:__cp_d+"/api/chat/change_agent",method:"POST",data:t}).done(function(t){1==t.result&&(t.data.agent&&(chatplusData.agent=t.data.agent),t.data.messages&&(chatplusData.messages=t.data.messages),___match_clMes_checking=a.text&&!t.data.match_clMes,t.data.status&&(chatplusData.status=t.data.status),t.data.wait&&(chatplusData.wait=t.data.wait,chatplusData.wait.force=!0,t.data.inChatWaiting&&(chatplusData.wait.inChatWaiting=!0)),a.text&&(client_messages.push(a.text),ruleaTemp&&0<ruleaTemp.length&&(check_new_message_flag=!0)),self.updateVisitor(),self.pingReset())}).fail(function(){})}),self.on("sendMessage",function(a){self.chatbotpart_ClMes(___chatbotData,___chatbotDataVisitor),pingStartTime=(new Date).getTime();var e=!1;a.start&&(e=!0);var t=document.__cp_f,s=document.__cp_p,i=JSON.stringify(jQueryPlus.extend(s,t)),c=((new Date).getTime()-___startTime)/1e3,r={key:access_key+"_"+site_id,text:a.text,start:e,no_assign:a.no_assign?a.no_assign:null,last_message_id:chatplusData.last_message_id,visitor_id:chatplusData.customer.visitor_id,check_chatbotpart:JSON.stringify(check_chatbotpart_data_temp),p:i,elapsed:c,rule_id:a.rule_id?a.rule_id:null,num:a.num?a.num:null,customer_tags:customer_tags};ping_flag=!1,clearTimeout(pingTimerID),jQueryPlus.ajax({url:__cp_d+"/api/chat/message",method:"POST",data:r}).done(function(t){1==t.result&&(chatplusData.status=e?"start_and_message":t.data.status,t.data.agent&&(chatplusData.agent=t.data.agent),chatplusData.messages=t.data.messages,___match_clMes_checking=a.text&&!t.data.match_clMes,t.data.wait&&(chatplusData.wait=t.data.wait,chatplusData.wait.force=!0,"wait_chat"==chatplusData.status&&chatplusData.wait&&(t.data.select&&(chatplusData.wait.select=!0),t.data.inChatWaiting&&(chatplusData.wait.inChatWaiting=!0))),client_messages.push(a.text),ruleaTemp&&0<ruleaTemp.length&&(check_new_message_flag=!0),self.updateVisitor()),self.pingReset()}).fail(function(t,a,e){console.error(t,a,e),self.pingReset()})}),self.on("receiveMessage",function(t){received_agent_writing=!1}),self.on("readmessage",function(t){jQueryPlus.ajax({url:__cp_d+"/api/chat/readmessage",method:"POST",data:{key:access_key+"_"+site_id,visitor_id:chatplusData.customer.visitor_id}}).done(function(t){t.result}).fail(function(){})}),self.on("createTicket",function(t){var a=null;(t.mess_success||t.mess_error)&&((a={}).success=t.mess_success,a.error=t.mess_error,delete t.mess_success,delete t.mess_error),t.attach||delete t.attach,pingStartTime=(new Date).getTime(),t.key=access_key+"_"+site_id,t.visitor_id=chatplusData.customer.visitor_id,jQueryPlus.ajax({url:__cp_d+"/admin/api/log/contact",data:t,method:"POST"}).done(function(t){a&&self.trigger("messageOffForm",{result:t.result,message:a}),self.pingReset()}).fail(function(t){a&&(jQueryPlus("#chatplusview #body h2").html(""),jQueryPlus("#chatplusview .form-horizontal").html(a.error))})}),self.on("formMail",function(t){t.key=access_key+"_"+site_id,t.visitor_id=chatplusData.customer.visitor_id,jQueryPlus.ajax({url:__cp_d+"/admin/api/log/formmail",data:t,method:"POST"})}),self.on("uploadFile",function(s){var t=s.target.prop("files")[0];if(10485760<=t.size)return self.trigger("uploadComplete",s),void self.trigger("uploadFailed",{text:"\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u304c\u5927\u304d\u3044\u305f\u3081\u3001\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002"});var a={key:access_key+"_"+site_id,visitor_id:chatplusData.customer.visitor_id,chatid:chatplusData.chat_id,text:s.text,event_type:31,last_message_id:chatplusData.last_message_id},e=new FormData;for(var i in a)e.append(i,a[i]);e.append("addfile",t),jQueryPlus.ajax({url:__cp_d+"/api/chat/upload",method:"post",data:e,datatype:"json",processData:!1,contentType:!1}).then(function(t){self.trigger("uploadComplete",s),"error"==t.result&&self.trigger("uploadFailed")},function(t,a,e){self.trigger("uploadComplete",s),self.trigger("uploadFailed")})}),self.on("uploadFormFile",function(a){var t={key:access_key+"_"+site_id,visitor_id:chatplusData.customer.visitor_id},e=new FormData;for(var s in t)e.append(s,t[s]);if("length"in a.target)for(var i=0,c=(s=0,a.target.length);s<c;s++){var r=jQueryPlus(a.target[s]);if(10485760<=(i+=(n=r.prop("files")[0]).size))return void self.trigger("uploadFailed",{text:"\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u304c\u5927\u304d\u3044\u305f\u3081\u3001\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002"});e.append(r.attr("data-name"),n)}else{var n;if(10485760<=(n=a.target.prop("files")[0]).size)return void self.trigger("uploadFailed",{text:"\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u304c\u5927\u304d\u3044\u305f\u3081\u3001\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002"});e.append("addfile",n)}jQueryPlus.ajax({url:__cp_d+"/api/chat/upload",method:"post",data:e,datatype:"json",processData:!1,contentType:!1}).then(function(t){"error"==t.result?self.trigger("uploadFailed"):a.callback&&a.callback(t)},function(t,a,e){self.trigger("uploadFailed")})}),self.on("dropFile",function(t){var a=new FormData;a.append("chatid",chatplusData.chat_id),a.append("key",access_key+"_"+site_id),a.append("text",null),a.append("last_message_id",chatplusData.last_message_id),a.append("event_type",31),a.append("visitor_id",chatplusData.customer.visitor_id),Array.prototype.forEach.call(t,function(t){a.append("addfile",t)}),jQueryPlus.ajax({url:__cp_d+"/api/chat/upload",method:"POST",data:a,processData:!1,contentType:!1}).then(function(t){"error"==t.result&&self.trigger("uploadFailed")},function(t,a,e){self.trigger("uploadFailed")})}),self.on("uploadFailed",function(t){var a={key:access_key+"_"+site_id,visitor_id:chatplusData.customer.visitor_id};t&&t.text&&(a.text=t.text),jQueryPlus.ajax({url:__cp_d+"/api/chat/upload_failed",method:"post",data:a})}),self.on("rateGood",function(t){pingStartTime=(new Date).getTime(),jQueryPlus.ajax({url:__cp_d+"/api/rating/chat/g/"+access_key+"/"+chatplusData.chat_id,method:"POST"}).done(function(t){self.pingReset()}).fail(function(){})}),self.on("rateBad",function(t){pingStartTime=(new Date).getTime(),jQueryPlus.ajax({url:__cp_d+"/api/rating/chat/b/"+access_key+"/"+chatplusData.chat_id,method:"POST"}).done(function(t){self.pingReset()}).fail(function(){})}),self.on("feedback",function(t){var a={key:access_key+"_"+site_id,visitor_id:chatplusData.customer.visitor_id,value:t.value,emptyCheck:t.emptyCheck};null!==t.rate&&(a.rate=t.rate),jQueryPlus.ajax({url:__cp_d+"/api/chat/feedback",method:"POST",data:a}).done(function(){}).fail(function(){})}),self.on("addVisitorAttribute",function(t,a){a?ChatplusAction.addVisitorAttributeEx(access_key,site_id,chatplusData.customer.visitor_id,t.attr,function(t){}):ChatplusAction.addVisitorAttribute(access_key,site_id,chatplusData.customer.visitor_id,t.attr,function(t){})}),self.on("addVisitorTag",function(t){var a=chatplus._.isArray(t.value)?t.value:[t.value];ChatplusAction.addVisitorTag(access_key,site_id,chatplusData.customer.visitor_id,a,function(t){})}),self.on("postback",function(t){t.chat_id=chatplusData.chat_id,ChatplusAction.postback(access_key,site_id,chatplusData.customer.visitor_id,t,function(t){})}),self.on("execRule",function(t){jQueryPlus.ajax({url:__cp_d+"/api/chat/ruleparts",method:"POST",data:{key:access_key+"_"+site_id,ids:[t.id],visitor_id:chatplusData.customer.visitor_id}}).done(function(t){t.result&&chatplus._.isArray(t.data.rules)&&(chatplus._.each(t.data.rules,function(t){"ruleId"==t.timer.on&&(t.timer.on="rule",t.id=t.id+"_"+(new Date).getTime(),___chatbotData.push(t))}),___ruleIdTime=(new Date).getTime(),clearInterval(chatbotpartId),___chatbotData=self.sort_chatbotpart(___chatbotData),chatbotpartId=setInterval(self.chatbotpart,1e3,___chatbotData,t.data.visitor))}).fail(function(){})}),self.on("submitOption",function(t){window.chatplus||(window.chatplus={}),window.chatplus.option=t,jQueryPlus.ajax({url:__cp_d+"/api/chat/option",method:"POST",dataType:"json",data:jQueryPlus.param({key:access_key+"_"+site_id,data:t})}).done(function(){})}),self.on("suppress",function(){if(window.localStorage)try{t=1440;chatplusData.config.appearance.end.hasOwnProperty("suppressTime")&&(t=chatplusData.config.appearance.end.suppressTime),localStorage.setItem("chat-suppressed-until",Date.now()+60*t*1e3)}catch(t){}else try{var t=1440;chatplusData.config.appearance.end.hasOwnProperty("suppressTime")&&(t=chatplusData.config.appearance.end.suppressTime),__cp_tracker.setCookie("chat-suppressed-until",Date.now()+60*t*1e3)}catch(t){}}),self.on("hideWindow",function(){ping_never=!(ping_flag=!1),clearTimeout(pingTimerID),self.pingReset()}),self.on("sendGaEvents",function(t){if(void 0!==window.ga&&chatplusData.config.ga&&chatplusData.config.ga.events){var a=chatplusData.chat_id,e={};try{e=window.localStorage?JSON.parse(window.localStorage.getItem("ga_used"))||{}:JSON.parse(__cp_tracker.getCookie("ga_used"))||{}}catch(t){console.log(t)}e[a]||((e={})[a]={});var s=chatplusData.config.ga.events,i=t.actions;if(i&&(Array.isArray(i)||(i=[i]),0!==i.length)){var c=window.ga.getByName("t0");c||(c=window.ga.getAll()[0]),chatplus._.each(i,function(t){s[t]&&s[t].active&&(/(^waitChat|^noAgent|First)$/.test(t)&&e[a][t]||(window.gtag?window.gtag("event",t,{event_category:"Chatplus",event_label:window.location.href,value:1}):c.send("event","Chatplus",t,window.location.href,{eventValue:1}),self.trigger("sendEvent",{events:t}),/(^waitChat|^noAgent|First)$/.test(t)&&(e[a][t]=1)))});try{window.localStorage?window.localStorage.setItem("ga_used",JSON.stringify(e)):__cp_tracker.setCookie("ga_used",JSON.stringify(e))}catch(t){console.log(t)}}}}),self.on("gotoURL",function(t){t.nomessage&&jQueryPlus.ajax({url:__cp_d+"/api/chat/eventlog",method:"POST",data:{key:access_key+"_"+site_id,url:"",bot_referer:t.rule_id?t.rule_id:null,num:t.num?t.num:null,visitor_id:chatplusData.customer.visitor_id}}).done(function(t){}).fail(function(){}),window.open(t.url,t.target)}),self.on("eventlog",function(t){jQueryPlus.ajax({url:__cp_d+"/api/chat/eventlog",method:"POST",data:{key:access_key+"_"+site_id,bot_referer:t.rule_id?t.rule_id:null,num:t.num?t.num:null,visitor_id:chatplusData.customer.visitor_id}}).done(function(t){}).fail(function(){})}),self.on("sendEvent",function(t){var n=["GTM"],a=t.events.split(" ");chatplus._.each(a,function(t){var a="",e=t.indexOf("_");if(0<e){var s=t.substr(0,e);chatplus._.contains(n,s)&&(a=s,t=t.substr(a.length+1))}var i={},c=t.indexOf("::");if(0<c){var r=t.substr(c+2);try{i=JSON.parse(r)}catch(t){console.log("chatplus json parse error for event"),i={}}t=t.substr(0,c)}if(""===a||"GTM"===a){if(!window.dataLayer)return;i.event=t,dataLayer.push(i)}})}),self.on("chatBeforeunload",function(t){self.chatbotpart(___chatbotData,___chatbotDataVisitor,!0);var a=localStorage?localStorage.getItem("lead_on_leavepage"):__cp_tracker.getCookie("lead_on_leavepage");if(a&&"null"!==a&&!showLead&&0==jQueryPlus('form[name="lead_form"]').length){var e=localStorage?localStorage.getItem("hiddenType"):__cp_tracker.getCookie("hiddenType");if(1==e&&"1"==__cp_tracker.getCookie("ever"+__cp_c))return;if(2==e&&"1"==__cp_tracker.getCookie("display"+__cp_c))return;if(4==e&&"1"==__cp_tracker.getCookie("close"+__cp_c))return;var s=window.setInterval(function(t){showLead=!0,__cp_tracker.displayLead(),__cp_tracker.setCookie("display"+__cp_c,"1"),clearInterval(s)},200,__cp_tracker)}}),self.on("pastMessages",function(a){var t={key:access_key+"_"+site_id,visitor_id:chatplusData.customer.visitor_id,chat_id:chatplusData.origin_chat_id};chatplusData.config.appearance.talking.showPastMessages?(t.past_chat_id=chatplusData.past_chat_id,t.past_message_id=chatplusData.past_message_id,t.past_message_first=chatplusData.past_message_first):chatplusData.config.rewind&&chatplusData.config.rewind.enabled&&(t.rewind=1,t.offset=chatplusData.past_messages_offset||0),jQueryPlus.ajax({type:"post",url:__cp_d+"/api/chat/pastmessages",data:t,success:function(t){1==t.result&&(chatplusData.past_message_id=t.data.past_message_id,chatplusData.past_messages_offset=t.data.past_messages_offset||0,self.trigger("showPastMessages",t.data)),a.callback&&a.callback.call(t.result)}})}),self.on("updateInfo",function(){ChatplusAction.getChatInfo(access_key,site_id,chatplusData.chat_id,function(t){t.result&&t.data&&("chat"in t.data&&"tags"in t.data.chat&&(chat_tags=t.data.chat.tags),"customer"in t.data&&"tags"in t.data.customer&&(customer_tags=t.data.customer.tags))})})}()},config=JSON.parse(config),riot.mount("*",config);
//# sourceMappingURL=visitor-client.min.js.map